#!/bin/bash
# Throwaway debug script — delete after diagnosing publish issues.
# Usage: ./scripts/npm-publish-debug [next]

scope=@covalent
tag=latest

[[ $1 = 'next' ]] && tag=next || tag=latest

# ── Auth Diagnostics ──
echo "=== NPM Auth Diagnostics ==="
echo "Token length: ${#NPM_TOKEN}"
echo "Token prefix: ${NPM_TOKEN:0:8}..."
echo "Token suffix: ...${NPM_TOKEN: -4}"

if [[ -z "$NPM_TOKEN" ]]; then
  echo "❌ NPM_TOKEN is empty — secret may not be available"
  exit 1
fi

if [[ "$NPM_TOKEN" =~ [[:space:]] ]]; then
  echo "⚠️  WARNING: Token contains whitespace characters!"
else
  echo "✅ No whitespace in token"
fi

echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >~/.npmrc
echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >.npmrc

echo ""
echo "=== npm whoami ==="
npm whoami --registry=https://registry.npmjs.org 2>&1 || echo "❌ npm whoami failed — token may be invalid"

echo ""
echo "=== .npmrc files ==="
echo "-- project .npmrc --"
cat .npmrc 2>/dev/null | sed 's/authToken=.*/authToken=***REDACTED***/' || echo "(none)"
echo "-- user .npmrc --"
cat ~/.npmrc 2>/dev/null | sed 's/authToken=.*/authToken=***REDACTED***/' || echo "(none)"

# ── Dry-run publish ──
echo ""
echo "=== Dry-Run Publish (tag: $tag) ==="
for package in ./dist/libs/*; do
  if [ -d "${package}" ]; then
    echo "[DRY-RUN] npm publish ${package} --access=public --tag=$tag --ignore-scripts --dry-run"
    npm publish "${package}" --access=public --tag="$tag" --ignore-scripts --dry-run
  fi
done

rm .npmrc
rm ~/.npmrc

echo ""
echo "Dry-run completed [scope: $scope]. No packages were actually published."
exit 0
