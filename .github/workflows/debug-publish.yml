name: Debug Publish (Dry Run)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'npm dist-tag to simulate'
        type: choice
        options:
          - latest
          - next
        default: latest

jobs:
  debug-publish:
    name: Build & Dry-Run Publish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build all packages (release:prepare)
        run: npm run release:prepare

      - name: List built packages
        run: |
          echo "=== Packages in dist/libs ==="
          ls -la dist/libs/ || echo "‚ùå dist/libs not found"
          echo ""
          for pkg in ./dist/libs/*/; do
            if [ -f "${pkg}package.json" ]; then
              echo "üì¶ $(jq -r '.name + "@" + .version' "${pkg}package.json")"
            fi
          done

      - name: Dry-run npm publish (diagnostics + publish)
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          tag_arg=""
          if [ "${{ inputs.tag }}" = "next" ]; then
            tag_arg="next"
          fi
          ./scripts/npm-publish-debug $tag_arg

      - name: Upload npm debug logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-debug-logs
          path: /home/runner/.npm/_logs/
          if-no-files-found: ignore
